name: Conda packaging osx-arm64

on:
  workflow_dispatch:

jobs:           
  macos:
    name: MacOS
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
      
      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          auto-update-conda: true          

      - name: Configure Conda for osx-arm64
        shell: bash -l {0}
        run: |
          conda config --set subdir osx-arm64
          echo "CONDA_SUBDIR=osx-arm64" >> $GITHUB_ENV

      - name: Install Dependencies
        shell: bash -l {0}
        run: |
          conda update --all     
          conda clean --all          
          conda install conda-build anaconda-client conda-verify
          conda config --set anaconda_upload no          

      - name: Build Package
        shell: bash -l {0}
        run: |
          conda-build conda.recipe -c set3mah -c conda-forge --no-test --output-folder  .

      - name: Build and upload the conda packages
        uses: set3mah/action-build-and-upload-conda-packages@v2.0.0
        with:
          meta_yaml_dir: conda.recipe
          user: set3mah
          token: ${{ secrets.ANACONDA_TOKEN }}
